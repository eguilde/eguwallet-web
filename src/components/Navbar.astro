---
import ThemeToggle from './ThemeToggle.astro';
import LanguageSelector from './LanguageSelector.astro';
import type { Translations } from '../i18n/index';

interface Props { t: Translations; lang: string; }
const { t, lang } = Astro.props;

const links = [
  { href: '#what',                   label: t.nav.what },
  { href: '#documents',              label: t.nav.documents },
  { href: '#usecases',               label: t.nav.useCases },
  { href: '#trust',                  label: t.nav.trust },
  { href: '#verifier',               label: t.verifier.navLabel },
  { href: '#faq',                    label: t.nav.faq },
  { href: `/${lang}/about/`,         label: t.nav.about },
  { href: `/${lang}/contact/`,       label: t.nav.contact },
];
---
<header class="sticky top-0 z-40 w-full t-bg border-b t-border backdrop-blur-sm">
  <nav class="max-w-6xl mx-auto flex items-center justify-between gap-2 sm:gap-4 px-3 sm:px-4 h-12 sm:h-14" aria-label="Main navigation">

    <a href={`/${lang}/`} class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0" aria-label="EguWallet home">
      <img src="/assets/logo-shield.svg" alt="" class="w-6 h-6 sm:w-7 sm:h-7" width="28" height="28" />
      <span class="font-bold text-[13px] sm:text-[15px] hidden sm:inline t-fg">EguWallet</span>
    </a>

    <ul class="hidden xl:flex items-center gap-0.5 flex-1 justify-center list-none m-0 p-0 flex-nowrap">
      {links.map(({ href, label }) => (
        <li class="flex-shrink-0">
          <a href={href} class="px-2 py-1.5 rounded-md text-[12px] font-medium t-fg opacity-70 hover:opacity-100 transition-opacity whitespace-nowrap">{label}</a>
        </li>
      ))}
    </ul>

    <div class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
      <LanguageSelector currentLang={lang} />
      <div class="hidden xl:flex items-center gap-1.5">
        <ThemeToggle />
      </div>

      <!-- Accessibility button (desktop only) -->
      <div class="relative hidden xl:flex" id="a11y-nav-wrapper">
        <button
          id="a11y-toggle"
          aria-label="Accessibility settings"
          aria-expanded="false"
          aria-controls="a11y-panel"
          class="min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg t-fg opacity-70 hover:opacity-100 transition-opacity"
          title="Accessibility settings"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="4" r="1.5" fill="currentColor" stroke="none"/>
            <path d="M6 8h12M12 8v12M9 14l-3 4M15 14l3 4"/>
          </svg>
        </button>

        <!-- Dropdown panel -->
        <div
          id="a11y-panel"
          role="region"
          aria-label="Accessibility tools"
          class="hidden absolute right-0 top-full mt-2 flex-col gap-3 p-4 rounded-2xl shadow-2xl z-50"
          style="background:#1a1a1a; border:1px solid rgba(255,255,255,0.12); min-width:220px;"
        >
          <!-- TTS -->
          <div>
            <p class="text-xs font-semibold mb-1.5 uppercase tracking-wider" style="color:rgba(255,255,255,0.50);">{t.a11y.listen}</p>
            <button id="a11y-tts" aria-pressed="false" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm font-medium transition-colors" style="background:rgba(255,255,255,0.08); color:#f0e8e8;"
              data-label-read={t.a11y.readAloud}
              data-label-stop={t.a11y.stopReading}
            >
              <span id="a11y-tts-icon" aria-hidden="true">ðŸ”Š</span>
              <span id="a11y-tts-label">{t.a11y.readAloud}</span>
            </button>
          </div>
          <!-- Font size -->
          <div>
            <p class="text-xs font-semibold mb-1.5 uppercase tracking-wider" style="color:rgba(255,255,255,0.50);">{t.a11y.textSize}</p>
            <div class="flex gap-1.5">
              {[0,1,2].map((i) => (
                <button
                  data-font-size={i}
                  class="a11y-font-btn flex-1 py-2 rounded-xl font-bold transition-colors"
                  style={`font-size: ${14 + i * 3}px; background:rgba(255,255,255,0.08); color:#f0e8e8;`}
                  aria-label={`Text size ${i === 0 ? 'normal' : i === 1 ? 'large' : 'extra large'}`}
                >A</button>
              ))}
            </div>
          </div>
          <!-- Contrast -->
          <div>
            <p class="text-xs font-semibold mb-1.5 uppercase tracking-wider" style="color:rgba(255,255,255,0.50);">{t.a11y.contrast}</p>
            <button id="a11y-contrast" aria-pressed="false" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm font-medium transition-colors" style="background:rgba(255,255,255,0.08); color:#f0e8e8;"
              data-label-off={t.a11y.highContrastOff}
              data-label-on={t.a11y.highContrastOn}
            >
              <span aria-hidden="true">â—‘</span>
              <span id="a11y-contrast-label">{t.a11y.highContrastOff}</span>
            </button>
          </div>
        </div>
      </div>

      <button
        id="nav-hamburger"
        aria-label="Open menu"
        aria-expanded="false"
        class="xl:hidden min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg t-fg"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>
  </nav>

  <div id="mobile-menu" class="hidden xl:hidden px-3 sm:px-4 pb-3 sm:pb-4 flex-col gap-0.5 sm:gap-1 t-bg">
    {links.map(({ href, label }) => (
      <a href={href} class="block px-3 py-2.5 rounded-lg text-[13px] font-medium t-fg" onclick="document.getElementById('mobile-menu').classList.add('hidden')">{label}</a>
    ))}
  </div>
</header>

<style is:global>
  [data-a11y-contrast="on"] {
    --eg-bg: #000000 !important;
    --eg-fg: #ffffff !important;
    --eg-surface-container: #111111 !important;
    --eg-surface-container-high: #1a1a1a !important;
    --eg-outline-var: #ffffff !important;
    --eg-primary: #ff6b6b !important;
    filter: contrast(1.15);
  }
  [data-a11y-contrast="on"] .eg-glass { background: #111111 !important; border-color: rgba(255,255,255,0.30) !important; }
  [data-a11y-contrast="on"] .eg-glass-dark { background: #000000 !important; border-color: rgba(255,255,255,0.25) !important; }
  [data-a11y-font="1"] { font-size: 112% !important; }
  [data-a11y-font="2"] { font-size: 128% !important; }
</style>

<script is:inline>
(function() {
  // â”€â”€ Hamburger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var hamburger = document.getElementById('nav-hamburger');
  var mobileMenu = document.getElementById('mobile-menu');
  if (hamburger) hamburger.addEventListener('click', function() {
    var open = mobileMenu ? mobileMenu.classList.toggle('hidden') === false : false;
    hamburger.setAttribute('aria-expanded', String(open));
  });

  // â”€â”€ Accessibility panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var panel        = document.getElementById('a11y-panel');
  var toggle       = document.getElementById('a11y-toggle');
  var ttsBtn       = document.getElementById('a11y-tts');
  var ttsLabel     = document.getElementById('a11y-tts-label');
  var ttsIcon      = document.getElementById('a11y-tts-icon');
  var contrastBtn  = document.getElementById('a11y-contrast');
  var contrastLabel= document.getElementById('a11y-contrast-label');
  var fontBtns     = document.querySelectorAll('.a11y-font-btn');
  var html         = document.documentElement;

  var labelRead       = (ttsBtn && ttsBtn.dataset.labelRead)       || 'Read page aloud';
  var labelStop       = (ttsBtn && ttsBtn.dataset.labelStop)       || 'Stop reading';
  var labelContrastOff= (contrastBtn && contrastBtn.dataset.labelOff) || 'High contrast: off';
  var labelContrastOn = (contrastBtn && contrastBtn.dataset.labelOn)  || 'High contrast: on';

  // Restore persisted settings
  applyFont(parseInt(localStorage.getItem('a11y-font') || '0'));
  applyContrast(localStorage.getItem('a11y-contrast') || 'off');

  if (toggle) toggle.addEventListener('click', function(e) {
    e.stopPropagation();
    var open = panel ? panel.classList.toggle('hidden') === false : false;
    if (panel) panel.classList.toggle('flex', open);
    toggle.setAttribute('aria-expanded', String(open));
  });

  document.addEventListener('click', function(e) {
    var wrapper = document.getElementById('a11y-nav-wrapper');
    if (wrapper && !wrapper.contains(e.target)) {
      if (panel) { panel.classList.add('hidden'); panel.classList.remove('flex'); }
      if (toggle) toggle.setAttribute('aria-expanded', 'false');
    }
  });

  if (ttsBtn) ttsBtn.addEventListener('click', function() {
    if (!('speechSynthesis' in window)) { alert('Text-to-speech not supported in this browser.'); return; }
    if (window.speechSynthesis.speaking) { window.speechSynthesis.cancel(); setTtsState(false); return; }
    var main = document.getElementById('main-content');
    var text = Array.from(main ? main.querySelectorAll('h1,h2,h3,h4,p,li') : [])
      .map(function(el) { return el.textContent ? el.textContent.trim() : ''; })
      .filter(function(t) { return t && t.length > 2; }).join('. ');
    var utt = new SpeechSynthesisUtterance(text);
    var bcp47 = {
      ro:'ro-RO', en:'en-GB', de:'de-DE', fr:'fr-FR', es:'es-ES',
      it:'it-IT', pl:'pl-PL', pt:'pt-PT', hu:'hu-HU', cs:'cs-CZ',
      sk:'sk-SK', bg:'bg-BG', hr:'hr-HR', lt:'lt-LT', lv:'lv-LV',
      et:'et-EE', mt:'mt-MT', sl:'sl-SI', sv:'sv-SE', da:'da-DK',
      nl:'nl-NL', el:'el-GR', fi:'fi-FI', ga:'ga-IE'
    };
    var lang = document.documentElement.lang || 'en';
    utt.lang = bcp47[lang] || lang;
    utt.rate = 0.92;
    utt.onstart = function() { setTtsState(true); };
    utt.onend = function() { setTtsState(false); };
    utt.onerror = function() { setTtsState(false); };
    window.speechSynthesis.speak(utt);
  });

  function setTtsState(speaking) {
    if (ttsBtn) ttsBtn.setAttribute('aria-pressed', String(speaking));
    if (ttsIcon) ttsIcon.textContent = speaking ? 'â¹' : 'ðŸ”Š';
    if (ttsLabel) ttsLabel.textContent = speaking ? labelStop : labelRead;
    if (ttsBtn) ttsBtn.style.background = speaking ? 'rgba(160,30,40,0.40)' : 'rgba(255,255,255,0.08)';
  }

  fontBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var level = parseInt(btn.getAttribute('data-font-size') || '0');
      applyFont(level);
      localStorage.setItem('a11y-font', String(level));
    });
  });

  function applyFont(level) {
    html.removeAttribute('data-a11y-font');
    if (level > 0) html.setAttribute('data-a11y-font', String(level));
    fontBtns.forEach(function(btn) {
      var active = parseInt(btn.getAttribute('data-font-size') || '0') === level;
      btn.style.background = active ? 'rgba(160,30,40,0.45)' : 'rgba(255,255,255,0.08)';
    });
  }

  if (contrastBtn) contrastBtn.addEventListener('click', function() {
    var next = html.getAttribute('data-a11y-contrast') === 'on' ? 'off' : 'on';
    applyContrast(next);
    localStorage.setItem('a11y-contrast', next);
  });

  function applyContrast(value) {
    html.setAttribute('data-a11y-contrast', value);
    if (contrastBtn) contrastBtn.setAttribute('aria-pressed', String(value === 'on'));
    if (contrastLabel) contrastLabel.textContent = value === 'on' ? labelContrastOn : labelContrastOff;
    if (contrastBtn) contrastBtn.style.background = value === 'on' ? 'rgba(160,30,40,0.45)' : 'rgba(255,255,255,0.08)';
  }
})();
</script>
