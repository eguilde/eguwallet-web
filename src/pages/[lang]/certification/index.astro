---
import '../../../styles/global.css';
import { SITE } from '../../../config/site.ts';
import { getTranslations } from '../../../i18n/index';
import Navbar from '../../../components/Navbar.astro';
import HeadSEO from '../../../components/HeadSEO.astro';

export async function getStaticPaths() {
  const locales = [
    'ro','en','de','fr','es','it','pl','pt','hu','cs',
    'sk','bg','hr','lt','lv','et','mt','sl','sv','da','nl','el','fi','ga'
  ];
  return locales.map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;

// Only EN and RO have a localised certification page; others redirect to EN
if (lang !== 'en' && lang !== 'ro') {
  return Astro.redirect('/en/certification/');
}

const t = await getTranslations(lang);
const tc = t.certification;

const COMPONENT_IDS = ['android-wallet', 'android-verifier', 'dgep', 'dgp'];
const REPORTS_BASE = 'https://eguilde.github.io/eguwallet-conformance/latest';

const ARF_DESCRIPTIONS: Record<string, string> = {
  'android-wallet': 'Wallet Application — ARF §5. Stores and presents PID and (Q)EAA credentials using OpenID4VP. Assessed against HAIP 1.0, DCQL, KB-JWT, WSCD/WSCA hardware binding.',
  'android-verifier': 'Relying Party Application — ARF §6. Reads ISO 18013-5 mdoc credentials via BLE proximity. Assessed for RP certificate validation and trust list verification.',
  'dgep': 'PID Issuer — ARF §6.3 + CIR 2024/2983. Issues SD-JWT Personal Identification Data (dc+sd-jwt format) via OpenID4VCI pre-authorized code flow.',
  'dgp': 'Attestation Issuer — ARF §6.4. Issues government attestations (Wallet Instance Attestation) and acts as OIDC provider. Assessed for WIA guard and credential format compliance.',
};

interface RemediationReport {
  component?: string;
  generatedAt?: string;
  overallStatus?: string;
  summary?: { total?: number; passed?: number; failed?: number };
  failures?: Array<{ id: string; title?: string; description?: string }>;
  cabDownloadUrl?: string;
  reportUrl?: string;
}

interface HistoryEntry {
  date: string;
  overallStatus: string;
  p1Count: number;
  p2Count: number;
  passedCount: number;
  failedCount: number;
}

async function fetchReport(component: string): Promise<RemediationReport | null> {
  const url = REPORTS_BASE + '/' + component + '/remediation.json';
  try {
    const controller = new AbortController();
    const timerId = setTimeout(() => controller.abort(), 5000);
    const res = await fetch(url, { signal: controller.signal });
    clearTimeout(timerId);
    if (!res.ok) return null;
    return await res.json() as RemediationReport;
  } catch {
    return null;
  }
}

function ragColor(s: string): string {
  return s === 'COMPLIANT' ? '#28a745' : s === 'PARTIAL' ? '#ffc107' : '#dc3545';
}

function statusStyle(status: string | undefined): string {
  if (status === 'COMPLIANT')     return 'color:#155724;background:#d4edda;';
  if (status === 'PARTIAL')       return 'color:#856404;background:#fff3cd;';
  if (status === 'NON_COMPLIANT') return 'color:#721c24;background:#f8d7da;';
  return 'color:inherit;background:rgba(0,0,0,0.06);opacity:0.65;';
}

function statusLabel(status: string | undefined, labels: Record<string, string>): string {
  const key = status ?? 'NOT_RUN';
  return labels[key] ?? labels['NOT_RUN'] ?? key;
}

function formatDate(iso: string | undefined, locale: string): string {
  if (!iso) return '—';
  try {
    return new Date(iso).toLocaleDateString(locale, {
      year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    });
  } catch {
    return iso;
  }
}

const dateLocale = lang === 'ro' ? 'ro-RO' : 'en-GB';
const statusLabels: Record<string, string> = {
  COMPLIANT:     tc.status.COMPLIANT,
  PARTIAL:       tc.status.PARTIAL,
  NON_COMPLIANT: tc.status.NON_COMPLIANT,
  NOT_RUN:       tc.status.NOT_RUN,
};
const componentNames: Record<string, string> = {
  'android-wallet':   tc.components['android-wallet'],
  'android-verifier': tc.components['android-verifier'],
  'dgep':             tc.components['dgep'],
  'dgp':              tc.components['dgp'],
};
const componentRoles: Record<string, string> = {
  'android-wallet':   tc.roles['android-wallet'],
  'android-verifier': tc.roles['android-verifier'],
  'dgep':             tc.roles['dgep'],
  'dgp':              tc.roles['dgp'],
};

const reports = await Promise.all(COMPONENT_IDS.map(fetchReport));

// Fetch history for each component
const histories: Record<string, HistoryEntry[] | null> = {};
await Promise.all(COMPONENT_IDS.map(async (c) => {
  try {
    const res = await fetch(REPORTS_BASE + '/' + c + '/history-index.json',
      { signal: AbortSignal.timeout(5000) });
    histories[c] = res.ok ? (await res.json() as HistoryEntry[]) : null;
  } catch {
    histories[c] = null;
  }
}));

interface CardData {
  component: string;
  compName: string;
  compRole: string;
  arfDesc: string;
  status: string | undefined;
  total: number;
  passed: number;
  failed: number;
  failures: Array<{ id: string; title?: string }>;
  updatedAt: string | undefined;
  reportUrl: string;
  cabUrl: string | null;
  passedPercent: number;
  progressColor: string;
  hasReport: boolean;
  history: HistoryEntry[] | null;
}

const cards: CardData[] = COMPONENT_IDS.map((component, i) => {
  const report = reports[i];
  const status = report?.overallStatus;
  const total = report?.summary?.total ?? 0;
  const passed = report?.summary?.passed ?? 0;
  const failed = report?.summary?.failed ?? 0;
  const progressColor =
    status === 'COMPLIANT' ? '#198754' :
    status === 'PARTIAL'   ? '#ffc107' : '#dc3545';
  return {
    component,
    compName: componentNames[component] ?? component,
    compRole: componentRoles[component] ?? '',
    arfDesc: ARF_DESCRIPTIONS[component] ?? '',
    status,
    total,
    passed,
    failed,
    failures: report?.failures ?? [],
    updatedAt: report?.generatedAt,
    reportUrl: report?.reportUrl ?? (REPORTS_BASE + '/' + component + '/report.html'),
    cabUrl: report?.cabDownloadUrl ?? null,
    passedPercent: total > 0 ? Math.round((passed / total) * 100) : 0,
    progressColor,
    hasReport: report !== null,
    history: histories[component] ?? null,
  };
});

// Precompute all history table rows as plain objects to avoid Astro generic TS parse issues
interface HistoryRow {
  date: string;
  statusLabel: string;
  ragBg: string;
  passedCount: number;
  failedCount: number;
  passedStyle: string;
  failedStyle: string;
}

const cardHistoryRows: Record<string, HistoryRow[]> = {};
for (const card of cards) {
  const rows: HistoryRow[] = [];
  if (card.history && card.history.length > 0) {
    for (const entry of card.history) {
      const totalFailed = entry.p1Count + entry.p2Count;
      rows.push({
        date: entry.date,
        statusLabel: statusLabels[entry.overallStatus] ?? entry.overallStatus,
        ragBg: ragColor(entry.overallStatus),
        passedCount: entry.passedCount,
        failedCount: totalFailed,
        passedStyle: entry.passedCount > 0 ? 'padding:4px 8px;color:#155724' : 'padding:4px 8px',
        failedStyle: totalFailed > 0 ? 'padding:4px 8px;color:#dc3545;font-weight:600' : 'padding:4px 8px',
      });
    }
  }
  cardHistoryRows[card.component] = rows;
}

const title = t.meta.certificationTitle;
const desc  = t.meta.certificationDesc;
const contactSubject = encodeURIComponent(lang === 'ro' ? 'Solicitare informații conformitate' : 'Conformance information request');
---
<!doctype html>
<html lang={lang} data-theme="light">
<head>
  <HeadSEO lang={lang} title={title} description={desc} canonical={`${SITE}/${lang}/certification/`} pathSuffix="certification/" />
</head>
<body class="t-bg t-fg">
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:px-4 focus:py-2 focus:rounded focus:t-bg focus:t-fg focus:outline-none focus:ring-2">
    {lang === 'ro' ? 'Sari la conținut' : 'Skip to main content'}
  </a>

  <Navbar t={t} lang={lang} />

  <main id="main-content" class="t-bg">

    <!-- Page header -->
    <div class="py-12 sm:py-16 px-4 sm:px-6 t-bg-surface-high">
      <div class="max-w-4xl mx-auto">
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <span class="text-[11px] sm:text-[12px] font-semibold uppercase tracking-widest px-2 py-0.5 rounded"
            style="background:rgba(160,30,40,0.10);color:var(--eg-primary);">
            eIDAS 2.0
          </span>
          <span class="text-[11px] sm:text-[12px] t-fg opacity-35 font-semibold uppercase tracking-widest">
            ⚡ {tc.autoGenerated}
          </span>
        </div>
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold t-fg mb-2">
          {tc.title}
        </h1>
        <p class="text-[14px] sm:text-base t-fg opacity-55 max-w-2xl">
          {tc.subtitle}
        </p>
        <p class="text-[11px] sm:text-[12px] t-fg opacity-35 mt-4">
          {tc.regulations}
        </p>
      </div>
    </div>

    <!-- Component cards -->
    <div class="py-10 sm:py-14 px-4 sm:px-6">
      <div class="max-w-4xl mx-auto flex flex-col gap-6">

        {cards.map((card) => (
          <div class="rounded-2xl p-5 sm:p-6 flex flex-col gap-4 t-bg-surface" style="border:1px solid var(--eg-glass-border);">

            <!-- Card header -->
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div class="flex flex-col gap-1">
                <h2 class="text-base sm:text-lg font-bold t-fg">{card.compName}</h2>
                <p class="text-[12px] sm:text-[13px] t-fg opacity-50">{card.compRole}</p>
                <p class="text-[11px] sm:text-[12px] t-fg opacity-40 max-w-xl leading-snug mt-0.5">{card.arfDesc}</p>
              </div>
              <span class="text-[11px] sm:text-xs font-semibold uppercase tracking-wider px-3 py-1 rounded-full flex-shrink-0 flex items-center gap-1.5"
                style={statusStyle(card.status)}>
                <span style={"display:inline-block;width:10px;height:10px;border-radius:50%;background:" + ragColor(card.status ?? 'NOT_RUN') + ";flex-shrink:0"}></span>
                {statusLabel(card.status, statusLabels)}
              </span>
            </div>

            {card.hasReport ? (
              <div class="flex flex-col gap-3">

                <!-- Check summary -->
                <div class="flex flex-wrap items-center gap-3 text-[13px] sm:text-[14px]">
                  <span class="t-fg opacity-50">{tc.checksLabel}:</span>
                  <span class="font-semibold t-fg">{card.total}</span>
                  <span style="color:#155724;" class="font-semibold">{card.passed} {tc.passed}</span>
                  {card.failed > 0 && (
                    <span style="color:#721c24;" class="font-semibold">· {card.failed} {tc.failed}</span>
                  )}
                </div>

                <!-- Progress bar -->
                {card.total > 0 && (
                  <div class="w-full rounded-full overflow-hidden h-1.5" style="background:rgba(0,0,0,0.08);">
                    <div
                      class="h-1.5 rounded-full transition-all"
                      style={'width:' + card.passedPercent + '%;background:' + card.progressColor + ';'}
                    />
                  </div>
                )}

                <!-- Failure list (collapsed) -->
                {card.failures.length > 0 && (
                  <details class="group">
                    <summary class="cursor-pointer list-none flex items-center gap-2 text-[12px] sm:text-[13px] t-fg opacity-60 select-none hover:opacity-90 transition-opacity">
                      <svg class="w-3.5 h-3.5 flex-shrink-0 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
                      <span>{card.failures.length} {lang === 'ro' ? 'verificări eșuate' : 'failed checks'}</span>
                    </summary>
                    <div class="mt-2 flex flex-col gap-1.5 pl-5">
                      {card.failures.slice(0, 10).map((f) => (
                        <div class="flex items-start gap-2 text-[12px] sm:text-[13px]">
                          <span style="color:#721c24;" class="flex-shrink-0 mt-0.5 font-bold">✗</span>
                          <span class="t-fg opacity-70 leading-snug">{f.title ?? f.id}</span>
                        </div>
                      ))}
                      {card.failures.length > 10 && (
                        <p class="text-[11px] t-fg opacity-40 pl-4">
                          {lang === 'ro' ? '… și încă ' + (card.failures.length - 10) + ' mai multe' : '… and ' + (card.failures.length - 10) + ' more'}
                        </p>
                      )}
                    </div>
                  </details>
                )}

                <!-- History table (collapsed) -->
                <details>
                  <summary style="cursor:pointer;font-size:0.85rem;color:var(--p-text-muted-color);margin-top:0.25rem;list-style:none;display:flex;align-items:center;gap:0.4rem;opacity:0.6;">
                    <svg style="width:14px;height:14px;flex-shrink:0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
                    {tc.historyTitle}
                  </summary>
                  {cardHistoryRows[card.component].length > 0 ? (
                    <table style="width:100%;border-collapse:collapse;font-size:0.8rem;margin-top:0.5rem">
                      <thead>
                        <tr style="border-bottom:1px solid var(--p-surface-200);text-align:left">
                          <th style="padding:4px 8px">{tc.historyDate}</th>
                          <th style="padding:4px 8px">{tc.historyStatus}</th>
                          <th style="padding:4px 8px">{tc.historyPassed}</th>
                          <th style="padding:4px 8px">{tc.historyFailed}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {cardHistoryRows[card.component].map((row) => (
                          <tr style="border-bottom:1px solid var(--p-surface-100)">
                            <td style="padding:4px 8px;font-family:monospace">{row.date}</td>
                            <td style="padding:4px 8px">
                              <span style={"display:inline-block;width:10px;height:10px;border-radius:50%;background:" + row.ragBg + ";vertical-align:middle;margin-right:4px"}></span>
                              {row.statusLabel}
                            </td>
                            <td style={row.passedStyle}>{row.passedCount}</td>
                            <td style={row.failedStyle}>{row.failedCount}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  ) : (
                    <p style="font-size:0.8rem;color:var(--p-text-muted-color);margin-top:0.5rem;opacity:0.6">{tc.noHistory}</p>
                  )}
                </details>

                <!-- Last updated + links -->
                <div class="flex flex-wrap items-center justify-between gap-3 pt-1" style="border-top:1px solid var(--eg-glass-border);">
                  <p class="text-[11px] sm:text-[12px] t-fg opacity-40">
                    {tc.lastUpdated}: {formatDate(card.updatedAt, dateLocale)}
                  </p>
                  <div class="flex flex-wrap gap-2">
                    <a
                      href={card.reportUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-1 text-[12px] sm:text-[13px] font-medium t-primary hover:underline"
                    >
                      {tc.viewFullReport}
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
                    </a>
                    {card.cabUrl && (
                      <a
                        href={card.cabUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-1 text-[12px] sm:text-[13px] font-medium t-fg opacity-60 hover:opacity-100 transition-opacity"
                      >
                        ↓ {tc.downloadCABPackage}
                      </a>
                    )}
                  </div>
                </div>

              </div>
            ) : (
              <p class="text-[13px] sm:text-[14px] t-fg opacity-50 italic">{tc.noData}</p>
            )}

          </div>
        ))}

      </div>
    </div>

    <!-- Contact section -->
    <div class="py-10 sm:py-14 px-4 sm:px-6 t-bg-surface-high">
      <div class="max-w-4xl mx-auto">
        <div class="flex flex-col gap-4 max-w-2xl">
          <h2 class="text-xl sm:text-2xl font-bold t-fg">{tc.contact.heading}</h2>
          <p class="text-[14px] sm:text-base t-fg opacity-70 leading-relaxed">{tc.contact.body}</p>
          <a
            href={'mailto:' + tc.contact.email}
            class="font-semibold text-base t-primary hover:underline self-start"
          >
            {tc.contact.email}
          </a>
          <p class="text-[13px] t-fg opacity-50 italic">{tc.contact.responseTime}</p>
          <a
            href={'mailto:' + tc.contact.email + '?subject=' + contactSubject}
            class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl font-semibold text-sm transition-opacity hover:opacity-90 self-start"
            style="background: var(--eg-gradient); color: #fff; box-shadow: 0 4px 20px rgba(160,30,40,0.30);"
          >
            {tc.contact.buttonLabel} →
          </a>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="py-8 px-4 sm:px-6 t-bg-surface-high">
      <div class="max-w-4xl mx-auto flex flex-wrap gap-x-4 gap-y-1 text-[12px] t-fg opacity-40">
        <a href={'/' + lang + '/'} class="hover:opacity-70 transition-opacity">EguWallet</a>
        <span>·</span>
        <a href={'/' + lang + '/privacy/'} class="hover:opacity-70 transition-opacity underline">{lang === 'ro' ? 'Confidențialitate' : 'Privacy Policy'}</a>
        <span>·</span>
        <a href={'/' + lang + '/terms/'} class="hover:opacity-70 transition-opacity underline">{lang === 'ro' ? 'Termeni' : 'Terms'}</a>
        <span>·</span>
        <a href={'/' + lang + '/contact/'} class="hover:opacity-70 transition-opacity underline">{lang === 'ro' ? 'Contact' : 'Contact'}</a>
        <span>·</span>
        <span>© 2026 IT Eguilde SRL</span>
      </div>
    </footer>

  </main>
</body>
</html>
