---
export const prerender = false;

const SUPPORTED = [
  'ro','en','de','fr','es','it','pl','pt','hu','cs',
  'sk','bg','hr','lt','lv','et','mt','sl','sv','da','nl','el','fi','ga'
];

function bestLangFromHeader(header: string | null): string {
  if (!header) return 'en';
  const tags = header.split(',').map(s => {
    const [tag, q = '1'] = s.trim().split(';q=');
    return { tag: tag.trim().toLowerCase(), q: parseFloat(q) };
  }).sort((a, b) => b.q - a.q);
  for (const { tag } of tags) {
    if (SUPPORTED.includes(tag)) return tag;
    const prefix = tag.split('-')[0];
    if (SUPPORTED.includes(prefix)) return prefix;
  }
  return 'en';
}

// Option 3:
// - Romanian IPs or unknown → serve RO content at / (no URL change, consistent for SEO)
// - Non-Romanian IPs        → 302 redirect to their language (clean, Google-approved)
// Cookie caches the result for 7 days to skip the geo lookup on repeat visits.

const cookieLang = Astro.cookies.get('egu-lang')?.value;

let lang: string;
let fromCookie = false;

if (cookieLang && SUPPORTED.includes(cookieLang)) {
  lang = cookieLang;
  fromCookie = true;
} else {
  // Detect country from IP
  const ip =
    Astro.request.headers.get('x-forwarded-for')?.split(',')[0].trim() ||
    Astro.request.headers.get('x-real-ip') ||
    '';

  let country = 'RO'; // default — serve Romanian if geo lookup fails

  if (ip && ip !== '127.0.0.1' && ip !== '::1') {
    try {
      const controller = new AbortController();
      const tid = setTimeout(() => controller.abort(), 300);
      const res = await fetch(`https://ip-api.com/json/${ip}?fields=countryCode`, {
        signal: controller.signal,
      });
      clearTimeout(tid);
      if (res.ok) {
        const data = await res.json() as { countryCode?: string };
        country = data.countryCode ?? 'RO';
      }
    } catch {
      // timeout or unreachable — keep default 'RO'
    }
  }

  if (country === 'RO') {
    lang = 'ro';
  } else {
    lang = bestLangFromHeader(Astro.request.headers.get('accept-language'));
  }

  // Cache for 7 days
  Astro.cookies.set('egu-lang', lang, {
    path: '/',
    maxAge: 60 * 60 * 24 * 7,
    sameSite: 'lax',
    secure: true,
  });
}

// All languages: 302 redirect — clean, Google-approved language detection pattern
// Note: Astro.rewrite() cannot rewrite to prerendered static pages in Node standalone mode.
// A 302 to /ro/ is SEO-equivalent (Google treats language redirects correctly).
return Astro.redirect(`/${lang}/`, 302);
---
